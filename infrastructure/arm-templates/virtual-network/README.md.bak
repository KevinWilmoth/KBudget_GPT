# Virtual Network ARM Template

This directory contains ARM templates and PowerShell scripts for deploying Azure Virtual Network with subnets and network security for the KBudget GPT application.

## Table of Contents

- [Overview](#overview)
- [Resources Created](#resources-created)
- [Network Architecture](#network-architecture)
- [Subnet Segmentation](#subnet-segmentation)
- [Deployment](#deployment)
- [Parameters](#parameters)
- [Scaling Considerations](#scaling-considerations)
- [Security Features](#security-features)
- [Post-Deployment](#post-deployment)
- [Troubleshooting](#troubleshooting)

## Overview

The Virtual Network (VNet) infrastructure provides network isolation and segmentation for the KBudget GPT application. The design follows Azure best practices for multi-tier applications with separate subnets for different workload types.

- **Virtual Network (VNet)**: Network isolation for Azure resources
- **Subnets**: Separate subnets for app, database, and functions
- **Network Security Groups (NSGs)**: Traffic filtering rules
- **Service Endpoints**: Secure access to Azure services

## Parameters

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| vnetName | string | - | Virtual Network name |
| location | string | Resource Group location | Azure region |
| vnetAddressPrefix | string | 10.0.0.0/16 | VNet address space |
| appSubnetName | string | app-subnet | Application subnet name |
| appSubnetPrefix | string | 10.0.1.0/24 | App subnet address range |
| dbSubnetName | string | db-subnet | Database subnet name |
| dbSubnetPrefix | string | 10.0.2.0/24 | DB subnet address range |
| funcSubnetName | string | func-subnet | Functions subnet name |
| funcSubnetPrefix | string | 10.0.3.0/24 | Functions subnet address range |
| enableDdosProtection | bool | false | Enable DDoS protection |
| tags | object | {} | Resource tags |

## Environment-Specific Configurations

### Development
- Address Space: 10.0.0.0/16
- DDoS Protection: Disabled

### Staging
- Address Space: 10.1.0.0/16
- DDoS Protection: Disabled

### Production
- Address Space: 10.2.0.0/16
- DDoS Protection: Enabled (recommended)

## Subnet Layout

| Subnet | Purpose | Address Range | Delegated To |
|--------|---------|---------------|--------------|
| app-subnet | App Service | 10.x.1.0/24 | Microsoft.Web/serverFarms |
| db-subnet | SQL Database | 10.x.2.0/24 | - |
| func-subnet | Functions | 10.x.3.0/24 | Microsoft.Web/serverFarms |

## Network Security Groups

### App Subnet NSG
- **Allow HTTPS (443)**: Inbound from Internet
- **Allow HTTP (80)**: Inbound from Internet (redirect to HTTPS in app)

### DB Subnet NSG
- **Allow SQL (1433)**: Only from app-subnet (10.x.1.0/24)
- **Deny all other inbound**: Default deny rule

## Service Endpoints

Configured on each subnet:
- Microsoft.Web (App Service)
- Microsoft.Storage (Storage Account)
- Microsoft.Sql (SQL Database)
- Microsoft.KeyVault (Key Vault)

Service endpoints provide secure, direct access to Azure services without going over the internet.

## Deployment

```powershell
New-AzResourceGroupDeployment `
    -Name "vnet-deployment" `
    -ResourceGroupName "kbudget-dev-rg" `
    -TemplateFile "virtual-network.json" `
    -TemplateParameterFile "parameters.dev.json"
```

## Outputs

| Output | Type | Description |
|--------|------|-------------|
| vnetId | string | Virtual Network resource ID |
| vnetName | string | Virtual Network name |
| appSubnetId | string | App subnet resource ID |
| dbSubnetId | string | Database subnet resource ID |
| funcSubnetId | string | Functions subnet resource ID |

## Post-Deployment

### Integrate App Service with VNet

```powershell
# Get subnet ID
$vnetName = "kbudget-dev-vnet"
$subnetName = "app-subnet"
$subnet = Get-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork (Get-AzVirtualNetwork -Name $vnetName -ResourceGroupName "kbudget-dev-rg")

# Integrate App Service
$webApp = Get-AzWebApp -ResourceGroupName "kbudget-dev-rg" -Name "kbudget-dev-app"
Set-AzWebApp -ResourceGroupName "kbudget-dev-rg" -Name "kbudget-dev-app" -VnetSubnetId $subnet.Id
```

### Configure SQL Firewall for VNet

```powershell
# Get subnet ID
$subnetId = (Get-AzVirtualNetworkSubnetConfig -Name "db-subnet" -VirtualNetwork (Get-AzVirtualNetwork -Name "kbudget-dev-vnet" -ResourceGroupName "kbudget-dev-rg")).Id

# Add virtual network rule to SQL Server
New-AzSqlServerVirtualNetworkRule `
    -ResourceGroupName "kbudget-dev-rg" `
    -ServerName "kbudget-dev-sql" `
    -VirtualNetworkRuleName "AllowAppSubnet" `
    -VirtualNetworkSubnetId $subnetId
```

### View Network Topology

```powershell
# Get VNet details
Get-AzVirtualNetwork -ResourceGroupName "kbudget-dev-rg" -Name "kbudget-dev-vnet" | Format-List

# View subnets
Get-AzVirtualNetworkSubnetConfig -VirtualNetwork (Get-AzVirtualNetwork -ResourceGroupName "kbudget-dev-rg" -Name "kbudget-dev-vnet")

# View NSG rules
Get-AzNetworkSecurityGroup -ResourceGroupName "kbudget-dev-rg" | Get-AzNetworkSecurityRuleConfig
```

## Security Features

- Subnet isolation
- NSG traffic filtering
- Service endpoints (no internet exposure)
- Subnet delegation for App Service integration
- DDoS protection (production)

## Network Flow

1. **Internet → App Service**:
   - Traffic hits App Service over HTTPS
   - App Service is in app-subnet (via VNet integration)

2. **App Service → SQL Database**:
   - Traffic flows through app-subnet → db-subnet
   - NSG allows only from app-subnet
   - Uses service endpoint (no internet)

3. **App Service → Storage/Key Vault**:
   - Uses service endpoints
   - Secure, private connection

## Troubleshooting

### Test Connectivity

```powershell
# From App Service, test SQL connectivity
# Use Kudu console (https://kbudget-dev-app.scm.azurewebsites.net)
# Run: tcpping kbudget-dev-sql.database.windows.net 1433
```

### View Effective NSG Rules

```powershell
$nic = Get-AzNetworkInterface -ResourceGroupName "kbudget-dev-rg"
Get-AzEffectiveNetworkSecurityGroup -NetworkInterfaceName $nic.Name -ResourceGroupName "kbudget-dev-rg"
```

## Cost Optimization

- VNet itself is free
- Service endpoints are free
- DDoS Protection Standard: ~$2,944/month (only enable in production if needed)
- Consider using Basic DDoS (free) for most scenarios
